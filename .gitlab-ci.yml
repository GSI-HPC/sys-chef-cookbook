---
stages:
  - rubocop
  - foodcritic
  - chefspec
  - kitchen

rubocop:
  stage: rubocop
  tags:
    - rubocop
  script:
    - rake rubocop

foodcritic:
  stage: foodcritic
  tags:
    - foodcritic
  script:
    - rake foodcritic
  allow_failure: true

chefspec:
  stage: chefspec
  script:
    - rake chefspec
  allow_failure: true

.kitchen:
  stage: kitchen
  resource_group: $CI_JOB_NAME-$CI_PROJECT_NAME
  script:
    - sleep $((RANDOM%30))
    - kitchen create $SUITE-$PLATFORM
    - kitchen converge $SUITE-$PLATFORM
    - kitchen verify $SUITE-$PLATFORM
  after_script:
    # make sure failed runs are always cleaned up too:
    - kitchen destroy $SUITE-$PLATFORM
  parallel:
    matrix:
      - SUITE:
        # - accounts
        # - apt
        # - autofs
        # - banner
        # - chef
        # - fail2ban
        # - ferm
        # - linuxlogo
        # - mail
        # - multipath
        # - nftables
        # - nsswitch
        # - ohai
        # - resolv
        # - rsyslog
        # - snmp
        # - ssh
        - ssl
        # - sudo
        # - systemd
        # - time
        - x509

# circumvent limit of 50 parallel jobs:
stretch:
  extends: .kitchen
  variables:
    PLATFORM: stretch
  allow_failure: true # Stretch vagrant images are currently broken

buster:
  extends: .kitchen
  variables:
    PLATFORM: buster
  tags:
    - kitchen
    - buster

bullseye:
  extends: .kitchen
  variables:
    PLATFORM: bullseye
  tags:
    - kitchen
    - bullseye

bookworm:
  extends: .kitchen
  variables:
    PLATFORM: bookworm
  tags:
    - kitchen
    - bookworm

trixie:
  extends: .kitchen
  variables:
    PLATFORM: trixie
  tags:
    - kitchen
    - trixie
  allow_failure: true

.post:
   script:
    - kitchen destroy
